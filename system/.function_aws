#!/usr/bin/env bash

# AWS
aws_token() {
  AWS_PROFILE=default
  if ! grep -q "[mfa]" $HOME/.aws/credentials; then
    echo '[mfa]' >> $HOME/.aws/credentials
  fi
  aws sts get-session-token --serial-number arn:aws:iam::676517209720:mfa/mmcnamara --token-code "$@" | jq -jr '["output = json", "region = us-east-1", "aws_access_key_id = \(.Credentials.AccessKeyId )", "aws_secret_access_key = \(.Credentials.SecretAccessKey)", "aws_session_token = \(.Credentials.SessionToken)",""] | join("\n")' > /tmp/creds && sed '/^\[mfa\]/,/^\[.*\]/{/^\[mfa\]/!{/^\[.*\]/!d;};}' $HOME/.aws/credentials | sed '/^\[mfa\]/r /tmp/creds' > /tmp/credentials && mv -f /tmp/credentials $HOME/.aws/credentials && rm -f /tmp/creds
  AWS_PROFILE=mfa
}
